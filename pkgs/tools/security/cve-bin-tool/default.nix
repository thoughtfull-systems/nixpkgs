{ lib
, buildPythonApplication
, fetchFromGitHub
, fetchpatch
, jsonschema
, plotly
, beautifulsoup4
, pyyaml
, isort
, py
, jinja2
, rpmfile
, reportlab
, zstandard
, rich
, aiohttp
, toml
, distro
  # aiohttp[speedups]
, aiodns
, brotlipy
, faust-cchardet
, pillow
, pytestCheckHook
, xmlschema
, setuptools
, packaging
, cvss
, google-cloud-sdk
, pip
, testers
, cve-bin-tool
# pinned packaging
, pyparsing
, fetchPypi
, buildPythonPackage
, pretend
, pythonOlder
, wheel
}:

let
  # pin packaging to < 22 until issue related to https://github.com/intel/cve-bin-tool/pull/2436 are resolved by upstream (post-3.2)
  packaging_21_3 = buildPythonPackage rec {
    inherit (packaging) pname passthru meta;
    version = "21.3";
    format = "pyproject";
    disabled = pythonOlder "3.6";

    src = fetchPypi {
      inherit pname version;
      sha256 = "sha256-3UfEKSfYmrkR5gZRiQfMLTofOLvQJjhZcGQ/nFuOz+s=";
    };
    nativeBuildInputs = [
      setuptools
      wheel
    ];
    propagatedBuildInputs = [
      pyparsing
    ];

    nativeCheckInputs = [
      pytestCheckHook
      pretend
    ];

    doCheck = false;
  };
in
buildPythonApplication rec {
  pname = "cve-bin-tool";
  version = "3.2";
  format = "setuptools";

  src = fetchFromGitHub {
    owner = "intel";
    repo = "cve-bin-tool";
    rev = "refs/tags/v${version}";
    hash = "sha256-QOnWt6iit0/F6d/MfZ8qJqDuT3IHh0Qjs6BcJkI/CBw=";
  };

  patches = [
    # Not needed as python dependency, should just be on the PATH
    ./no-gsutil-python-dependency.patch
    # Already merged upstream, to be removed post-3.2
    # https://github.com/intel/cve-bin-tool/pull/2524
    (fetchpatch {
      name = "cve-bin-tool-version-success.patch";
      url = "https://github.com/intel/cve-bin-tool/commit/6f9bd565219932c565c1443ac467fe4163408dd8.patch";
      hash = "sha256-Glj6qiOvmvsuetXn4tysyiN/vrcOPFLORh+u3BoGzCI=";
    })
    # https://github.com/intel/cve-bin-tool/issues/2977 and https://github.com/intel/cve-bin-tool/issues/2969
    (fetchpatch {
      name = "fix-curl-datasource.patch";
      url = "https://github.com/intel/cve-bin-tool/commit/499e0a036e8abf39b3dcdae5377dc61eb8d4a26f.patch";
      hash = "sha256-fwvlKwOGiD2Bqr8tjTreukF1ZqaSEspQlVnLbmxYEOk=";
    })
    # https://www.openwall.com/lists/oss-security/2024/05/26/1
    (fetchpatch {
      name = "path-traversal-tar-extract.patch";
      url = "https://github.com/intel/cve-bin-tool/commit/b4feb03f19acecc1bb8b18db192d87a510819c24.patch";
      hash = "sha256-r7WBnuunZoKlq3404kkoaPrTD+QQRw3H2SNsWXC8GUs=";
      excludes = [ ".pre-commit-config.yaml" ];
    })
  ];

  # Wants to open a sqlite database, access the internet, etc
  doCheck = false;

  propagatedNativeBuildInputs = [
    pip
  ];

  propagatedBuildInputs = [
    google-cloud-sdk
    jsonschema
    plotly
    beautifulsoup4
    pyyaml
    isort
    py
    jinja2
    rpmfile
    reportlab
    zstandard
    rich
    aiohttp
    toml
    distro
    # aiohttp[speedups]
    aiodns
    brotlipy
    faust-cchardet
    # needed by brotlipy
    pillow
    setuptools
    xmlschema
    cvss
    packaging_21_3
  ];

  nativeCheckInputs = [
    pytestCheckHook
  ];

  pythonImportsCheck = [
    "cve_bin_tool"
  ];

  passthru.tests.version = testers.testVersion { package = cve-bin-tool; };

  meta = with lib; {
    description = "CVE Binary Checker Tool";
    homepage = "https://github.com/intel/cve-bin-tool";
    license = licenses.gpl3Plus;
    maintainers = [ ];
  };
}
